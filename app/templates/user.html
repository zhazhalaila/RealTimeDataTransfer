{% extends "base.html" %}

{% block app_content %}
    <table class="table table-hover">
        <tr>
            <td width="128px"><img src="{{ user.avatar(128) }}"></td>
            <td>
                <h1>{{ _('User') }}: {{ user.username }}</h1>
                {% if user.last_seen %}
                <p>{{ _('Last seen on') }}: {{ moment(user.last_seen).format('LLL') }}</p>
                {% endif %}
                <p>{{ _('%(count)d followers', count=user.followers.count()) }}, {{ _('%(count)d following', count=user.followed.count()) }}</p>
                {% if not current_user.is_following(user) %}
                <p><a href="{{ url_for('main.follow', username=user.username) }}">{{ _('Follow') }}</a></p>
                {% else %}
                <p><a href="{{ url_for('main.unfollow', username=user.username) }}">{{ _('Unfollow') }}</a></p>
                {% endif %}
            </td>
        </tr>
    </table>
    <hr>
    <div class="row">
        <div class="col-sm-6 col-md-4">
            <div class="thumbnail">
                <div class="container">
                    <p id="message">...</p>
                </div>
            </div>
        </div>
    </div>
    <div>

    <div class="row">
        <div class="col-sm-6 col-md-4">
            <div>
                <canvas id="myChart"></canvas>
            </div>
        </div>
        <div class="col-sm-6 col-md-4">
            <div>
                <canvas id="myChart1" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    {% for sensor in sensors %}
        {% include '_sensor.html' %}
    {% endfor %}
    <nav aria-label="...">
        <ul class="pager">
            <li class="previous{% if not prev_url %} disabled{% endif %}">
                <a href="{{ prev_url or '#' }}">
                    <span aria-hidden="true">&larr;</span> {{ _('Newer posts') }}
                </a>
            </li>
            <li class="next{% if not next_url %} disabled{% endif %}">
                <a href="{{ next_url or '#' }}">
                    {{ _('Older posts') }} <span aria-hidden="true">&rarr;</span>
                </a>
            </li>
        </ul>
    </nav>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if current_user.username == user.username %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('subscribe', {topic: '{{ current_user.mqtt_topic }}'});
            socket.emit('publish', {topic: '{{ current_user.mqtt_publish_topic }}', status: 'USER_ONLINE'});
        });
        socket.on('{{ current_user.mqtt_topic }}', function(data) {
            $('#message').text(data.payload);
        });
    </script>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script type="text/javascript" charset="utf-8">
    function renderChart(data, labels) {
        var ctx = document.getElementById("myChart").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '24 Hours',
                    data: data,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                }]
            },
        });
    }

    function renderChart1(data, labels) {
        var ctx = document.getElementById("myChart1").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '24 Hours',
                    data: data,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                }]
            },
        });
    }

    $(document).ready(function(){
        $.ajax({
            url: '{{ url_for("api.user_api", username=user.username) }}',
            type: 'GET',
            success: function(data) {
                var data = data.reverse();
                var labels = [];
                var temperature = [];
                data.forEach(function (element) {
                    //parse date to hours string
                    var date = new Date(element['sensor_time']).getHours().toString();
                    //parse temperature to float
                    var value = JSON.parse(element['sensor_value']);
                    temperature.push(parseFloat(value['temperature']));
                    labels.push(date);
                });
                renderChart(temperature, labels);
            }
        })
    });
</script>
{% endblock %}