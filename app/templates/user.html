{% extends "base.html" %}

{% block app_content %}
    <table class="table table-hover">
        <tr>
            <td width="128px"><img src="{{ user.avatar(128) }}"></td>
            <td>
                <h1>{{ _('User') }}: {{ user.username }}</h1>
                {% if user.last_seen %}
                <p>{{ _('Last seen on') }}: {{ moment(user.last_seen).format('LLL') }}</p>
                {% endif %}
                <p>{{ _('%(count)d followers', count=user.followers.count()) }}, {{ _('%(count)d following', count=user.followed.count()) }}</p>
                {% if not current_user.is_following(user) %}
                <p><a href="{{ url_for('main.follow', username=user.username) }}">{{ _('Follow') }}</a></p>
                {% else %}
                <p><a href="{{ url_for('main.unfollow', username=user.username) }}">{{ _('Unfollow') }}</a></p>
                {% endif %}
            </td>
        </tr>
    </table>
    <hr>
    <div class="row">
        <div class="col-sm-6 col-md-4">
            <div class="thumbnail">
                <div class="caption">
                    <p id="message">...</p>
                </div>
            </div>
        </div>
    </div>
    {% for sensor in sensors %}
        {% include '_sensor.html' %}
    {% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
{% if current_user.username == user.username %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('subscribe', {topic: '{{ current_user.mqtt_topic }}'});
        });
        socket.on('{{ current_user.mqtt_topic }}', function(data) {
            $('#message').text(data.payload);
        });
        window.addEventListener("beforeunload", function (e) {
            socket.emit('unsubscribe', {topic: '{{ current_user.mqtt_topic }}'});
        });
</script>
{% endif %}
{% endblock %}